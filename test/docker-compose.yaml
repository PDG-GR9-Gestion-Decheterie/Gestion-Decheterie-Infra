version: "3.8"

networks:
  bdr-net:
    driver: bridge

services:
  postgresql:
    image: "bitnami/postgresql:16"
    container_name: bdr-postgresql
    environment:
      - POSTGRESQL_USERNAME=bdr
      - POSTGRESQL_PASSWORD=bdr
      - POSTGRESQL_DATABASE=bdr
      - POSTGRESQL_POSTGRES_PASSWORD=root
    ports:
      - 5432:5432
    volumes:
      - pg_data:/bitnami/postgresql 
      - ./db:/docker-entrypoint-initdb.d
    networks:
      - bdr-net

  reverse_proxy:
    image: traefik
    command:
      - --providers.docker
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./traefik/ssl:/etc/traefik/certificates
      - ./traefik/traefik.yaml:/etc/traefik/traefik.yaml
    ports:
      - "80:80" # Web sites
      - "443:443" # Web sites
      - "8080:8080" # Traefik dashboard

  backend:
    build:
      context: ../../Gestion-Decheterie-Backend/backend
      dockerfile: Dockerfile
    labels:
      - traefik.http.routers.backend.rule=Host(`localhost`) &&
        PathPrefix(`/api`)
      - traefik.http.routers.backend.entrypoints=https
      - traefik.http.routers.backend.tls=true
      - traefik.http.services.backend.loadbalancer.sticky=true
      - traefik.http.services.backend.loadbalancer.sticky.cookie.name=StickyCookie
      - traefik.http.services.backend.loadbalancer.sticky.cookie.secure=true
      - traefik.http.services.backend.loadbalancer.sticky.cookie.samesite=strict
    deploy:
      replicas: 1

  frontend:
    build:
      context: ../../Gestion-Decheterie-Frontend/frontend
      dockerfile: Dockerfile
    labels:
      - traefik.http.routers.frontend.rule=Host(`localhost`)
      - traefik.http.routers.frontend.entrypoints=https
      - traefik.http.routers.frontend.tls=true
    deploy:
      replicas: 1

volumes:
  pg_data: